---
layout: post
title: Adding a counter cache for fun and profit
date: '2014-07-26T11:24:00.001-07:00'
author: lokesh jain
tags:
- ruby
- counter_Cache
- ruby on rails
modified_time: '2014-08-11T02:05:41.601-07:00'
blogger_id: tag:blogger.com,1999:blog-3986102045809195254.post-1813157371379830719
blogger_orig_url: http://phptricksand.blogspot.com/2014/07/adding-counter-cache-for-fun-and-profit_26.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Very important for getting the couters for the related Relations in the rails .<br /><br />Plz, complete this for the project it will reduce a lot of headache and queries will be faster.<br /><br /><br /><br /><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 18px; margin-bottom: 9px;">Let's say you visit one of your Rails app's pages in your browser and, in glancing at your logs, you happen to notice a whole bunch of these:</div><div class="highlight" style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 18px;"><pre style="background-color: whitesmoke; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; border-top-left-radius: 4px; border-top-right-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.14902); font-family: Menlo, Monaco, 'Courier New', monospace; font-size: 12px; margin-bottom: 9px; padding: 8.5px; white-space: pre-wrap; word-break: break-all; word-wrap: break-word;"><code class="text" style="background-color: transparent; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-top-left-radius: 3px; border-top-right-radius: 3px; border: 0px; color: inherit; font-family: Menlo, Monaco, 'Courier New', monospace; padding: 0px;"> (0.3ms) SELECT COUNT(*) FROM "wheels" WHERE "wheels"."vehicle_id" = 1<br /> (0.3ms) SELECT COUNT(*) FROM "wheels" WHERE "wheels"."cohort_id" = 2<br /> (0.2ms) SELECT COUNT(*) FROM "wheels" WHERE "wheels"."cohort_id" = 3<br /> (1.1ms) SELECT COUNT(*) FROM "wheels" WHERE "wheels"."cohort_id" = 4<br /> (1.0ms) SELECT COUNT(*) FROM "wheels" WHERE "wheels"."cohort_id" = 5<br /> (1.1ms) SELECT COUNT(*) FROM "wheels" WHERE "wheels"."cohort_id" = 6<br /> (0.5ms) SELECT COUNT(*) FROM "wheels" WHERE "wheels"."cohort_id" = 7<br /> (0.3ms) SELECT COUNT(*) FROM "wheels" WHERE "wheels"."cohort_id" = 8<br /></code></pre></div><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 18px; margin-bottom: 9px;">This is a sure sign that it's time to add a counter_cache. A counter cache in Rails is just an additional column that tracks the number of associated models. For instance, here's how you'd setup your two models:</div><div class="highlight" style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 18px;"><pre style="background-color: whitesmoke; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; border-top-left-radius: 4px; border-top-right-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.14902); font-family: Menlo, Monaco, 'Courier New', monospace; font-size: 12px; margin-bottom: 9px; padding: 8.5px; white-space: pre-wrap; word-break: break-all; word-wrap: break-word;"><code class="text" style="background-color: transparent; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-top-left-radius: 3px; border-top-right-radius: 3px; border: 0px; color: inherit; font-family: Menlo, Monaco, 'Courier New', monospace; padding: 0px;">class Wheel &lt; ActiveRecord::Base<br />  belongs_to :vehicle, counter_cache: true<br />end<br /><br />class Vehicle &lt; ActiveRecord::Base<br />  has_many :wheels<br />end<br /></code></pre></div><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 18px; margin-bottom: 9px;">Then, we need to add a migration:</div><div class="highlight" style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 18px;"><pre style="background-color: whitesmoke; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; border-top-left-radius: 4px; border-top-right-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.14902); font-family: Menlo, Monaco, 'Courier New', monospace; font-size: 12px; margin-bottom: 9px; padding: 8.5px; white-space: pre-wrap; word-break: break-all; word-wrap: break-word;"><code class="text" style="background-color: transparent; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-top-left-radius: 3px; border-top-right-radius: 3px; border: 0px; color: inherit; font-family: Menlo, Monaco, 'Courier New', monospace; padding: 0px;">class AddWheelsCountToVehicles &lt; ActiveRecord::Migration<br />  def up<br />    add_column :vehicles, :wheels_count, :integer, default: 0, null: false<br /><br />    Vehicle.find_each(select: 'id') do |result|<br />      Vehicle.reset_counters(result.id, :wheels)<br />    end<br />  end<br /><br />  def down<br />    remove_column :vehicles, :wheels_count<br />  end<br />end<br /></code></pre></div><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 18px; margin-bottom: 9px;">This migration will add a column, named&nbsp;<code style="background-color: #f7f7f9; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-top-left-radius: 3px; border-top-right-radius: 3px; border: 1px solid rgb(225, 225, 232); color: #dd1144; font-family: Menlo, Monaco, 'Courier New', monospace; font-size: 12px; padding: 3px 4px;">wheels_count</code>&nbsp;to the&nbsp;<code style="background-color: #f7f7f9; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-top-left-radius: 3px; border-top-right-radius: 3px; border: 1px solid rgb(225, 225, 232); color: #dd1144; font-family: Menlo, Monaco, 'Courier New', monospace; font-size: 12px; padding: 3px 4px;">vehicles</code>&nbsp;table, and set the default to 0. It then proceeds to iterate through all Vehicles in the database, one-at-a-time selecting just the vehicle ID. Next, the Rails&nbsp;<code style="background-color: #f7f7f9; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-top-left-radius: 3px; border-top-right-radius: 3px; border: 1px solid rgb(225, 225, 232); color: #dd1144; font-family: Menlo, Monaco, 'Courier New', monospace; font-size: 12px; padding: 3px 4px;">reset_counters</code>&nbsp;method is called on Vehicle. Given an ID of a Vehicle and the counter_cache column to update, Rails will count the number of associated Wheel objects and update the<code style="background-color: #f7f7f9; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-top-left-radius: 3px; border-top-right-radius: 3px; border: 1px solid rgb(225, 225, 232); color: #dd1144; font-family: Menlo, Monaco, 'Courier New', monospace; font-size: 12px; padding: 3px 4px;">wheels_count</code>&nbsp;column.</div><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 18px; margin-bottom: 9px;">Of course, if you have a lot of Vehicles in your database, that migration could take some time to run, so plan ahead for how you'll deploy this to your app.</div><br /><br /><br /><a href="http://www.elegantruby.com/Tutorials/2013/01/25/adding-a-counter-cache-for-fun-and-profit/">Adding a counter cache for fun and profit</a>: <br /><br /><br /><br /></div>